generator client {
  provider        = "prisma-client"
  output          = "../src/app/generated/prisma"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  extensions = [vector]
}

model User {
  id              String         @id @default(cuid())
  email           String         @unique
  name            String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  credits         Int            @default(0)
  asaasCustomerId String?        @unique
  sessions        StudySession[]
  transactions    Transaction[]
  usageLogs       UsageLog[]
  trialRedeemed   Boolean        @default(false)
  feedbacks       Feedback[]
}

model Feedback {
  id        String   @id @default(cuid())
  userId    String? // Optional: allows anonymous reports if they can't login
  type      String // "BUG", "FEATURE", "OTHER"
  message   String   @db.Text
  url       String? // The specific page where the bug happened
  metadata  Json? // { browser: "Chrome", os: "Windows", width: 1920 }
  status    String   @default("OPEN") // "OPEN", "RESOLVED", "IGNORED"
  createdAt DateTime @default(now())

  user User? @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([status])
}

model UsageLog {
  id         String   @id @default(cuid())
  userId     String
  action     String // e.g. "GENERATE_QUESTIONS"
  cost       Int // e.g. 1
  resourceId String? // ID of the Unit/Source created
  modelUsed  String? // "gemini-1.5-flash"
  tokensIn   Int?
  tokensOut  Int?
  createdAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
}

model Transaction {
  id            String   @id @default(cuid())
  userId        String
  amount        Float
  status        String
  createdAt     DateTime @default(now())
  asaasId       String   @unique
  creditsAmount Int
  invoiceUrl    String?
  pixCode       String?
  updatedAt     DateTime @updatedAt
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model ContentSource {
  id        String         @id @default(cuid())
  title     String
  bodyText  String         @map("body_text")
  status    SourceStatus   @default(UNPROCESSED)
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
  subjectId String?
  userId    String
  fileUrl   String?
  chunks    ContentChunk[]
  subject   Subject?       @relation(fields: [subjectId], references: [id])
  units     StudyUnit[]
  topics    Topic[]        @relation("ContentSourceToTopic")

  @@index([userId])
}

model ContentChunk {
  id         String                 @id @default(cuid())
  content    String
  pageNumber Int
  embedding  Unsupported("vector")?
  sourceId   String
  source     ContentSource          @relation(fields: [sourceId], references: [id], onDelete: Cascade)

  @@index([sourceId])
}

model StudyUnit {
  id          String        @id @default(cuid())
  sourceId    String
  type        UnitType
  content     String
  createdAt   DateTime      @default(now())
  description String?
  questions   Question[]
  source      ContentSource @relation(fields: [sourceId], references: [id], onDelete: Cascade)

  @@index([sourceId])
}

model Subject {
  id        String          @id @default(cuid())
  name      String
  color     String
  createdAt DateTime        @default(now())
  userId    String
  sources   ContentSource[]
  questions Question[]
  topics    Topic[]

  @@unique([name, userId])
}

model Topic {
  id        String          @id @default(cuid())
  name      String
  subjectId String
  userId    String
  subject   Subject         @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  sources   ContentSource[] @relation("ContentSourceToTopic")
  questions Question[]      @relation("QuestionToTopic")

  @@unique([name, subjectId, userId])
  @@index([subjectId])
}

model Question {
  id             String       @id @default(cuid())
  unitId         String
  type           QuestionType
  data           Json
  createdAt      DateTime     @default(now())
  easeFactor     Float        @default(2.5)
  interval       Int          @default(0)
  lastReviewed   DateTime?
  nextReviewDate DateTime     @default(now())
  streak         Int          @default(0)
  subjectId      String?
  userId         String
  subject        Subject?     @relation(fields: [subjectId], references: [id])
  unit           StudyUnit    @relation(fields: [unitId], references: [id], onDelete: Cascade)
  topics         Topic[]      @relation("QuestionToTopic")

  @@index([unitId])
  @@index([userId])
}

model StudySession {
  id        String   @id @default(cuid())
  userId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model StudyLog {
  id            String   @id @default(cuid())
  userId        String?
  date          DateTime @default(now())
  itemsReviewed Int      @default(0)

  @@index([date])
}

enum SourceStatus {
  UNPROCESSED
  PROCESSED
}

enum UnitType {
  TEXT
  CODE
}

enum QuestionType {
  MULTI_CHOICE
  SNIPPET
  CLOZE
  OPEN
}
